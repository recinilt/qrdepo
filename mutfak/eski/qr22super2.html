<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR and Barcode Reader with Product Table</title>
  <script src="html5-qrcode-master/minified/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- <link rel="stylesheet" href="qrstyle.css"> -->
   <style>
    
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    #reader {
      width: 300px;
      margin: 20px auto;
    }

    #results {
      margin-top: 20px;
    }

    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
    }

    table,
    th,
    td {
      border: 1px solid black;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
  
   </style>
</head>

<body>
  <h1>QR and Barcode Reader with Product Table</h1>
  <h3>Kullanımı</h3>
  <ul>
    <li>Start Scanning'e basın ve ilaç kutusunun qr kodunu okutun.</li>
    <li>Eğer taratılan ürünler tablosunda ilacın ismi tanımlı değilse, ürün adı-içerik sayısı bölümüne ilacın ismini ve içeriğinin sayısını (kaç tablet vb.) yazıp kaydet'e basın, otomatik güncelleyecektir.</li>
    <li>Raflara kaydetmek için, raftaki ilaçları okutup raf ismini girip (mesela 1. Raf, veya da birinci çekmece vb.) Rafı Kaydet'e basın ve diğer raf sayımına geçin.</li>
    <li>Ürün kodu-ürün adı eşleşmelerini başka bir bilgisayara veya telefona yüklemek için, ürün kodu ürün adı eşleşmelerini bilgisayara kaydet deyin, indirilen dosyayı yeni cihaza gönderin, o cihazda sayıma başlamadan önce dosya seç ile o dosyayı okuyun ve sayıma başlayın.</li>
    <li>Sayım sonucunu excel formatında indirmek için, Product Summary Tablosunu İndir ve Raf Tablolarını İndir tablolarını kullanın.</li>

  </ul>
  
  <button id="start-btn">Start Scanning</button>
  <div id="reader" style="display: none;"></div>
  <div id="results">
    <h2>Scanned Products</h2>
    <table id="product-table">
      <thead>
        <tr>
          <th>Product Code</th>
          <th>Year</th>
          <th>Month</th>
          <th>Product Name</th>
          <th>Full QR/Barcode</th>
          <th>Ürün Adı - İçerik Sayısı</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <div id="summary-results">
    <h2>Product Summary</h2>
    <table id="summary-table">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Total Count</th>
          <th>Total Unit Count</th>
          <th>Details (Year-Month: Count)</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <div id="shelf-results">
    <h2>Current Shelf</h2>
    <table id="shelf-table">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Total Count</th>
          <th>Total Unit Count</th>
          <th>Details (Year-Month: Count)</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <input type="text" id="shelf-name" placeholder="Raf ismi girin">
    <button id="save-shelf-btn">Rafı Kaydet</button>
  </div>

  <div id="saved-shelves">
    <h2>Saved Shelves</h2>
  </div>

  <div>
    <button id="download-btn">Ürün Kodu - Ürün Adı Eşleşmelerini Bilgisayara Kaydet</button>
    <p></p><br>
    <input type="file" id="upload-btn">(Dosya yüklendiğinde otomatik olarak Ürün Kodu - Ürün Adı eşleşmelerini Dosyadan Getirir.)
  </div>
  <div>
  <button id="download-summary-btn">Product Summary Tablosunu İndir</button>
<button id="download-shelves-btn">Raf Tablolarını İndir</button>
</div>

  <script>
  

// Product Summary tablosunu Excel dosyası olarak indirme fonksiyonu
function downloadSummaryTable() {
  const ws = XLSX.utils.table_to_sheet(document.getElementById('summary-table'));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Product Summary');
  XLSX.writeFile(wb, 'product_summary.xlsx');
}

// Raf tablolarını Excel dosyası olarak indirme fonksiyonu
function downloadShelfTables() {
  const wb = XLSX.utils.book_new();
  const shelfDivs = savedShelvesDiv.querySelectorAll('div');
  shelfDivs.forEach((shelfDiv, index) => {
    const shelfName = shelfDiv.querySelector('h3').textContent;
    const shelfTable = shelfDiv.querySelector('table');
    const ws = XLSX.utils.table_to_sheet(shelfTable);
    XLSX.utils.book_append_sheet(wb, ws, shelfName || `Raf ${index + 1}`);
  });
  XLSX.writeFile(wb, 'raflar.xlsx');
}

// Butonlara event listener ekleme
document.getElementById('download-summary-btn').addEventListener('click', downloadSummaryTable);
document.getElementById('download-shelves-btn').addEventListener('click', downloadShelfTables);


    const startButton = document.getElementById('start-btn');
    const readerDiv = document.getElementById('reader');
    const productTableBody = document.querySelector('#product-table tbody');
    const summaryTableBody = document.querySelector('#summary-table tbody');
    const shelfTableBody = document.querySelector('#shelf-table tbody');
    const shelfNameInput = document.getElementById('shelf-name');
    const saveShelfButton = document.getElementById('save-shelf-btn');
    const savedShelvesDiv = document.getElementById('saved-shelves');
    const downloadBtn = document.getElementById('download-btn');
    const uploadBtn = document.getElementById('upload-btn');
    let qrCodeScanner;

    // Başlangıçta ürün adlarını ve birim sayılarını depolamak için bir nesne
    let productNames = {
      "0108680760092235": { name: "Ibucold C 30 tb", unitCount: 30 }
    };

    // Sanal tablo verilerini tutacak dizi
    let virtualTableData = [];

    // Local Storage'dan ürün adlarını ve birim sayılarını yükle
    function loadProductNames() {
      const storedNames = localStorage.getItem('productNames');
      if (storedNames) {
        const parsedNames = JSON.parse(storedNames);
        // HTML'deki varsayılan değerleri koruyarak güncelle
        productNames = { ...productNames, ...parsedNames };
      } else {
        // LocalStorage'de veri yoksa, başlangıç verilerini kullan
        localStorage.setItem('productNames', JSON.stringify(productNames));
      }
    }

    // Sayfa yüklendiğinde çalıştır
    loadProductNames();

    // Başlangıçta ve her raf kaydedildiğinde sanal tabloyu oluştur ve "Current Shelf" tablosunu güncelle
    function initializeVirtualTable() {
      virtualTableData = []; // Sanal tabloyu sıfırla
      updateCurrentShelf();
    }

    initializeVirtualTable(); // Sayfa yüklendiğinde ilklendir

    startButton.addEventListener('click', () => {
      if (!qrCodeScanner) {
        startScanning();
      }
    });

    function startScanning() {
      readerDiv.style.display = 'block';
      startButton.disabled = true;

      qrCodeScanner = new Html5Qrcode("reader");
      qrCodeScanner.start(
        { facingMode: "environment" }, // Use the back camera
        {
          fps: 10,
          qrbox: 250,
        },
        (decodedText) => {
          stopScanning();
          processScannedCode(decodedText);
        },
        (errorMessage) => {
          console.log(`Scanning failed: ${errorMessage}`);
        }
      ).catch(err => {
        console.error(`Unable to start scanning: ${err}`);
        startButton.disabled = false;
      });
    }

    function stopScanning() {
      if (qrCodeScanner) {
        qrCodeScanner.stop().then(() => {
          qrCodeScanner.clear();
          qrCodeScanner = null;
          readerDiv.style.display = 'none';
          startButton.disabled = false;
        }).catch(err => {
          console.error(`Unable to stop scanning: ${err}`);
        });
      }
    }

    function processScannedCode(decodedText) {
      // Attempt to split QR code by the delimiter
      const parts = decodedText.split('');
      if (parts.length >= 3) {
        const productCode = parts[1].slice(0, 16);
        const year = "20" + parts[2].slice(2, 4);
        const month = parts[2].slice(4, 6);
        const product = productNames[productCode] || { name: "Unknown Product", unitCount: 1 }; // Varsayılan olarak birim sayısı 1
        addProductToTable(productCode, year, month, product.name, decodedText, product.unitCount);
      } else {
        // Barkod için Product Code kısmına da barkodu yaz
        addProductToTable(decodedText, "N/A", "N/A", "Barcode", decodedText, 1);
      }
    }

    function updateSummaryTable() {
      const rows = Array.from(productTableBody.rows);
      const productSummary = {};


      // Ürünleri gruplama
      rows.forEach(row => {
        const productName = row.cells[3].textContent; 
        
        const year = row.cells[1].textContent;
        const month = row.cells[2].textContent;
        const unitCount = parseInt(row.cells[5].querySelector('.unit-count').value) || 1; // Birim sayısını al
        const yearMonth = `${year}-${month}`;

        if (!productSummary[productName]) {
          productSummary[productName] = { total: 0, totalUnits: 0, details: {} };
        }

        productSummary[productName].total += 1;
        productSummary[productName].totalUnits += unitCount; // Birim sayısını toplama ekle

        if (!productSummary[productName].details[yearMonth]) {
          productSummary[productName].details[yearMonth] = 0;
        }

        productSummary[productName].details[yearMonth] += 1;
      });

      // Tabloyu doldurma
      summaryTableBody.innerHTML = '';

      Object.keys(productSummary)
        .sort() // Alfabetik sıralama
        .forEach(productName => {
          const product = productSummary[productName];
          const detailStrings = Object.entries(product.details)
            .map(([yearMonth, count]) => `${yearMonth}: ${count}`)
            .join(', ');

          const newRow = document.createElement('tr');
          newRow.innerHTML = `
                              <td>${productName}</td>
                              <td>${product.total}</td>
                              <td>${product.totalUnits}</td> 
                              <td>${detailStrings}</td>
                              `;

          summaryTableBody.appendChild(newRow);
        });
    }












    // "Current Shelf" tablosunu güncelle
    function updateCurrentShelf() {
      const productSummary = {};

      // Sanal tablo verilerini kullanarak ürünleri grupla
      virtualTableData.forEach(item => {
        const { productCode, year, month, productName, unitCount } = item;
        const yearMonth = `${year}-${month}`;

        if (!productSummary[productName]) {
          productSummary[productName] = { total: 0, totalUnits: 0, details: {} };
        }

        productSummary[productName].total += 1;
        productSummary[productName].totalUnits += unitCount;

        if (!productSummary[productName].details[yearMonth]) {
          productSummary[productName].details[yearMonth] = 0;
        }

        productSummary[productName].details[yearMonth] += 1;
      });

      // Tabloyu doldur
      shelfTableBody.innerHTML = '';

      Object.keys(productSummary)
        .sort()
        .forEach(productName => {
          const product = productSummary[productName];
          const detailStrings = Object.entries(product.details)
            .map(([yearMonth, count]) => `${yearMonth}: ${count}`)
            .join(', ');

          const newRow = document.createElement('tr');
          newRow.innerHTML = `
                              <td>${productName}</td> 
                              <td>${product.total}</td>
                              <td>${product.totalUnits}</td>
                              <td>${detailStrings}</td>
                              `;
          shelfTableBody.appendChild(newRow);
        });
    }

    function addProductToTable(productCode, year, month, productName, fullCode, unitCount = 1) {
      const newRow = document.createElement('tr');

      // Silme butonu ekleme
      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'X';
      deleteButton.style.backgroundColor = 'red'; // Butonu kırmızı yap
      deleteButton.style.display = 'block'; // display özelliğini block olarak ayarla
      deleteButton.addEventListener('click', () => {
        // Satırı tablodan kaldır
        const rowIndex = newRow.rowIndex;
        productTableBody.deleteRow(rowIndex - 1); // rowIndex, başlık satırını da içerir, bu yüzden 1 çıkarıyoruz

        // Sanal tablodan veriyi kaldır
        virtualTableData = virtualTableData.filter(item => item.productCode !== productCode);

        // Özet tabloyu ve raf tablosunu güncelle
        updateSummaryTable();
        updateCurrentShelf();
      });

      const deleteCell = document.createElement('td');
      deleteCell.appendChild(deleteButton);
      

      // Input ve buton ekleme
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Ürün adı girin';
      nameInput.value = productName; // Varsayılan değeri ayarla

      const unitCountInput = document.createElement('input');
      unitCountInput.type = 'number';
      unitCountInput.classList.add('unit-count'); // Class ekle
      unitCountInput.placeholder = 'Birim sayısı';
      unitCountInput.value = unitCount; // Varsayılan değeri ayarla

      const saveButton = document.createElement('button');
      saveButton.textContent = 'Kaydet';
      saveButton.addEventListener('click', () => {
        const newProductName = nameInput.value.trim();
        const newUnitCount = parseInt(unitCountInput.value) || 1; // Birim sayısını al, geçersizse 1 olarak ayarla
        if (newProductName) {
          // Ürün adını ve birim sayısını güncelle
          const productCell = newRow.cells[4]; // 4. hücre Product Name (silme butonu eklendiğinden dolayı)
          productCell.textContent = newProductName;

          // Local Storage'a kaydet
          productNames[productCode] = { name: newProductName, unitCount: newUnitCount };
          localStorage.setItem('productNames', JSON.stringify(productNames));

          // Sanal tabloyu güncelle
          virtualTableData = virtualTableData.map(item => 
            item.productCode === productCode 
              ? { ...item, productName: newProductName, unitCount: newUnitCount } 
              : item
          );

          // Özet tabloyu ve raf tablosunu güncelle
          updateSummaryTable();
          updateCurrentShelf(); // "Current Shelf" tablosunu güncelle
        }
      });

      const actionsCell = document.createElement('td');
      actionsCell.appendChild(nameInput);
      actionsCell.appendChild(unitCountInput);
      actionsCell.appendChild(saveButton);

      // newRow.innerHTML = ... satırını buraya taşıyoruz
      newRow.innerHTML = `
                                  <td>${productCode}</td>
                                  <td>${year}</td>
                                  <td>${month}</td>
                                  <td>${productName}</td> 
                                  <td>${fullCode}</td>
                                  `;

      newRow.appendChild(actionsCell);
      newRow.appendChild(deleteCell);

      productTableBody.appendChild(newRow);
      sortTable();
      updateSummaryTable(); // Özet tablosunu güncelle

      // Sanal tabloya veri ekle
      virtualTableData.push({
        productCode,
        year,
        month,
        productName,
        unitCount
      });

      updateCurrentShelf(); // "Current Shelf" tablosunu güncelle
    }



    function sortTable() {
      const rows = Array.from(productTableBody.rows);
      rows.sort((a, b) => {
        const productA = a.cells[0].textContent;
        const productB = b.cells[0].textContent;
        

        if (productA === productB) {
          const yearA = a.cells[1].textContent;
          const yearB = b.cells[1].textContent;

          if (yearA === yearB) {
            const monthA = parseInt(a.cells[2].textContent);
            const monthB = parseInt(b.cells[2].textContent);
            return monthA - monthB;
          }

          return yearA.localeCompare(yearB);
        }

        return productA.localeCompare(productB);
      });

      productTableBody.innerHTML = '';
      rows.forEach(row => productTableBody.appendChild(row));
    }



    function sortTable() {
  const rows = Array.from(productTableBody.rows);
  rows.sort((a, b) => {
    const productA = a.cells[1].textContent; // 1. hücre Product Code
    const productB = b.cells[1].textContent; // 1. hücre Product Code

    // ... (fonksiyonun geri kalanı) ...
  });

  // ... (fonksiyonun geri kalanı) ...
}






    // Rafı kaydetme işlemi
    saveShelfButton.addEventListener('click', () => {
      const shelfName = shelfNameInput.value.trim();
      if (shelfName) {
        // Yeni bir tablo oluştur ve içeriği kopyala
        const newShelfTable = document.createElement('table');
        newShelfTable.innerHTML = `
                              <thead>
                                  <tr>
                                      <th>Product Name</th>
                                      <th>Total Count</th>
                                      <th>Total Unit Count</th>
                                      <th>Details (Year-Month: Count)</th>
                                  </tr>
                              </thead>
                              <tbody>${shelfTableBody.innerHTML}</tbody>
                              `;

        // Yeni tabloyu savedShelvesDiv'e ekle
        const shelfDiv = document.createElement('div');
        shelfDiv.innerHTML = `<h3>${shelfName}</h3>`;
        shelfDiv.appendChild(newShelfTable);
        savedShelvesDiv.appendChild(shelfDiv);

        // Raf tablosunu sıfırla ve sanal tabloyu yeniden başlat
        shelfTableBody.innerHTML = '';
        shelfNameInput.value = '';
        initializeVirtualTable();
      }
    });

    // Verileri indirme işlemi
    downloadBtn.addEventListener('click', () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productNames));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "product_data.json");
      document.body.appendChild(downloadAnchorNode); // required for firefox
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    });

    // Verileri yükleme işlemi
    uploadBtn.addEventListener('change', (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const loadedData = JSON.parse(event.target.result);
          // Yüklenen verileri mevcut verilere ekle
          productNames = { ...productNames, ...loadedData };
          localStorage.setItem('productNames', JSON.stringify(productNames));
          // Tabloları güncelle
          updateSummaryTable();
          updateCurrentShelf();
        } catch (error) {
          console.error("Hata: Geçersiz JSON dosyası.", error);
          alert("Hata: Geçersiz JSON dosyası.");
        }
      }
      reader.readAsText(file);
    });

  </script>
</body>

</html>